# Segmentation

Address space에서 CODE, DATA, HEAP, STACK을 사용하면서 내부 free space는
물리 메모리에서 볼 때 사용 중인 공간처럼 보일 수 있다.\
이를 해결하기 위해 **Segmentation** 개념이 도입되었다.

기존에는 **하나의 프로세스 전체가 하나의 base & bound**를 가졌다면,\
Segmentation에서는 **code, data, heap, stack 각각이 독립적인 base &
bound**를 갖는다.

------------------------------------------------------------------------

## Explicit Approach

VA(virtual address)의 **상위 비트(top few bits)**로 segment를 구분한다.

  Segment   Bits
  --------- ------
  CODE      00
  HEAP      01
  ---       10
  STACK     11

예: `4200` → `01 0000 0110 1000`\
→ 상위 2비트 = `01` → HEAP segment

-   **SEG_MASK** = `11 0000 0000 0000`\
-   **SHIFT 12** → segment 추출\
-   **OFFSET_MASK** = `00 1111 1111 1111` → offset 추출

------------------------------------------------------------------------

## Address Translation on Segmentation

### ✔ CODE segment

    Physical Address = Base + Offset

예: offset = 100, Base = 32KB\
→ PA = 100 + 32KB = 32868

------------------------------------------------------------------------

### ✔ HEAP segment

예: virtual address = 4200\
offset = 4200 − 4KB = 104\
Base = 34KB\
→ PA = 104 + 34KB = 34920

할당된 heap 범위 초과 시 **Segmentation Fault** 발생.

------------------------------------------------------------------------

### ✔ STACK segment

Stack은 **주소가 감소 방향으로 성장**한다.

    Negative Offset = Offset − Maximum Segment Size
    Physical Address = Base + Negative Offset

예: Base = 28KB, Offset = 3KB, Max size = 4KB\
→ Negative Offset = 3KB − 4KB = −1KB\
→ PA = −1KB + 28KB = 27KB

------------------------------------------------------------------------

## Support for Sharing

Segmentation은 **segment 단위로 공유(Sharing)**가 가능하다.

각 segment는 **protection bits**를 가진다.

  Segment   허용 권한
  --------- ----------------------------
  CODE      read, execute (write 금지)
  HEAP      read, write (execute 금지)
  STACK     read, write (execute 금지)

------------------------------------------------------------------------

## Granularity

### ✔ Coarse-Grain

큰 단위로 분류 (예: CODE, HEAP, STACK)

### ✔ Fine-Grain

더 세밀한 단위로 분류 → **HW에서 segment table 필요**

------------------------------------------------------------------------

## External Fragmentation

free space가 여러 조각으로 흩어져 있어서,\
**전체 공간은 충분하지만 연속된 공간이 없어 할당이 불가능한 상태**.

해결 방법: - **Compaction (메모리 재배치)** - 실제 시스템에서는
**Paging이 더 일반적**
